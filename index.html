// --- CONFIGURATION ---
const BASE_URL = "https://solutionspelichet.github.io/weconnect"; // Mettez votre URL GitHub
const NOM_FEUILLE = "DonneesCartes";
const NOM_DOSSIER_DRIVE = "Wemet_Photos"; // Dossier où iront les images

// --- 1. INITIALISATION ---
function SETUP_INITIALISATION() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(NOM_FEUILLE);

  if (!sheet) {
    sheet = ss.insertSheet(NOM_FEUILLE);
    // Supprimer la feuille par défaut si vide
    try { ss.deleteSheet(ss.getSheetByName('Feuille 1')); } catch(e){}
  }

  // NOUVELLES COLONNES AJOUTÉES : prenom, linkedin
  var headers = ['id', 'prenom', 'nom', 'societe', 'poste', 'telephone', 'email', 'site_web', 'linkedin', 'photo_url'];

  // Si on a moins de colonnes que prévu ou feuille vide, on met à jour
  if (sheet.getLastRow() === 0 || sheet.getLastColumn() < headers.length) {
    // On efface et on remet les headers pour être sûr
    sheet.getRange(1, 1, 1, sheet.getLastColumn() || 1).clearContent();
    sheet.appendRow(headers);
    sheet.setFrozenRows(1);
    sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold').setBackground('#e0e0e0');
    Logger.log("✅ Colonnes mises à jour avec Prénom et LinkedIn !");
  }
}

function getSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(NOM_FEUILLE);
  if (!sheet) { SETUP_INITIALISATION(); return ss.getSheetByName(NOM_FEUILLE); }
  return sheet;
}

// --- 2. GESTION DRIVE (POUR LES PHOTOS) ---
function getOrCreateFolder() {
  var folders = DriveApp.getFoldersByName(NOM_DOSSIER_DRIVE);
  if (folders.hasNext()) {
    return folders.next();
  } else {
    return DriveApp.createFolder(NOM_DOSSIER_DRIVE);
  }
}

// --- 3. API LECTURE (GET) ---
function doGet(e) {
  var sheet = getSheet();
  var rows = sheet.getDataRange().getValues();
  var headers = rows[0];
  var data = [];

  for (var i = 1; i < rows.length; i++) {
    var row = rows[i];
    var record = {};
    for (var j = 0; j < headers.length; j++) {
      record[headers[j]] = row[j];
    }
    data.push(record);
  }

  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

// --- 4. API ÉCRITURE (POST) ---
function doPost(e) {
  try {
    var sheet = getSheet();
    var params = JSON.parse(e.postData.contents);
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    // -- GESTION PHOTO (UPLOAD) --
    if (params.photo_data && params.photo_name) {
      try {
        var folder = getOrCreateFolder();
        var data = Utilities.base64Decode(params.photo_data.split(',')[1]); // Enlever le header base64
        var blob = Utilities.newBlob(data, params.photo_mime, "photo_" + params.id + "_" + new Date().getTime());
        var file = folder.createFile(blob);
        file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        
        // On génère le lien d'affichage direct
        params.photo_url = "https://drive.google.com/uc?export=view&id=" + file.getId();
      } catch (err) {
        // Si erreur upload, on garde l'ancienne URL si elle existe
      }
    }

    // -- SAUVEGARDE DONNÉES --
    var rows = sheet.getDataRange().getValues();
    var rowIndex = -1;
    
    // On cherche si l'ID existe
    for (var i = 1; i < rows.length; i++) {
      if (rows[i][0] == params.id) {
        rowIndex = i + 1;
        break;
      }
    }

    if (rowIndex === -1) {
      // NOUVEAU : Si ID non trouvé, on crée une nouvelle ligne
      var newRow = [];
      headers.forEach(function(header) {
        newRow.push(params[header] || "");
      });
      sheet.appendRow(newRow);
    } else {
      // UPDATE : Si ID trouvé, on met à jour
      headers.forEach(function(header, colIndex) {
        // On ne met à jour que si la donnée est envoyée (pour ne pas effacer la photo si pas de nouvelle upload)
        if (params[header] !== undefined && params[header] !== "") {
           sheet.getRange(rowIndex, colIndex + 1).setValue(params[header]);
        }
      });
    }

    // Liens pour l'email
    var publicLink = BASE_URL + "/?id=" + params.id;
    var editLink = BASE_URL + "/admin.html?id=" + params.id;
    var qrCodeUrl = "https://quickchart.io/qr?text=" + encodeURIComponent(publicLink) + "&size=300";

    // Envoi Email
    if (params.email) {
      sendConfirmationEmail(params.email, params.prenom || params.nom, publicLink, editLink, qrCodeUrl);
    }

    return ContentService.createTextOutput(JSON.stringify({"result": "success", "photo_url": params.photo_url}))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({"result": "error", "message": error.message}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function sendConfirmationEmail(email, name, publicLink, editLink, qrCodeUrl) {
  var htmlBody = `
    <div style="font-family: sans-serif; border: 1px solid #ccc; padding: 20px; border-radius: 10px;">
      <h2 style="color:#2563eb">Carte mise à jour !</h2>
      <p>Bonjour ${name},</p>
      <p>Voici votre lien : <a href="${publicLink}">${publicLink}</a></p>
      <img src="${qrCodeUrl}" width="150">
      <p style="color:gray; font-size:12px">Modifiez vos infos ici : <a href="${editLink}">${editLink}</a></p>
    </div>`;
  MailApp.sendEmail({to: email, subject: "Votre Carte Wemet", htmlBody: htmlBody});
}
